#!/bin/bash

ARGS=${@:-"test"}

SCRIPT_NAME=`basename "${BASH_SOURCE[0]}"`
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
SOLR_CONTAINER=tellusr_solr
TELLUSR_VERSION=${TELLUSR_VERSION:-"latest"}

## Some default project config variables
PROJECT=default
PROJECT_DIR=.
if [ -f "./tellusr.env" ]; then
    PROJECT_DIR=`realpath "."`
elif [ -f "../tellusr.env" ]; then
    PROJECT_DIR=`realpath ".."`
elif [ -f "../../tellusr.env" ]; then
    PROJECT_DIR=`realpath "../.."`
elif [ -f "../../../tellusr.env" ]; then
    PROJECT_DIR=`realpath "../../.."`
fi
SOLR_CONFIG_DIR=$PROJECT_DIR/configset
SOLR_HOST="localhost"
SOLR_PORT="8984"
SOLR_DATA_VOLUME="tellusr_solr_${PROJECT}_data"
BUILD_ROOT=$PROJECT_DIR


## Load local overrides for config variables
source "$PROJECT_DIR/tellusr.env"

## Docker on MacOS does not support --network=host, compensate
if [[ "$OSTYPE" == "darwin"* ]]
then
    LOCALHOST="host.docker.internal"
    TELLUSR_RUN_OPTIONS="--rm"
else
    LOCALHOST="localhost"
    TELLUSR_RUN_OPTIONS="--network=host --rm"
fi

## Check if docker command needs to be run as sudo
DOCKER=$(docker ps &> /dev/null && echo "docker" || echo "sudo docker")

function run {
    $DOCKER volume rm tellusr_solr_test_data 2> /dev/null || echo -n
    $DOCKER run \
            -d ${TELLUSR_RUN_OPTIONS} \
            -p $SOLR_PORT \
            -e SOLR_HEAP=${SOLR_HEAP:-"3096m"} \
            -e TELLUSR_BACKEND_URL=${BACKEND_URL:-"http://$LOCALHOST:${BACKEND_PORT:-"8989"}"} \
            -e SOLR_DISABLE_SECURITY_JSON="true" \
            -e SOLR_PORT=$SOLR_PORT \
            -v $SOLR_DATA_VOLUME:/var/solr \
            -v $BUILD_ROOT/configset:/setup/configset \
            --log-driver none \
            --name ${SOLR_CONTAINER} \
            tellusr/demo:${TELLUSR_VERSION}
    sleep 1
}

function _migrate_data() {
    ## Check if migrate_data function is defined in tellusr.env, and if so run it
    if [ _migrate_data_defined ]
    then
	migrate_data $1 $2
    fi
}

function volume_drop {
    echo -n "Dropping volume: "
    $DOCKER volume rm $SOLR_DATA_VOLUME
    _migrate_data $SOLR_HOST $SOLR_PORT
}

function migrate {
    echo -n "Attached to: "
    $DOCKER exec -t ${SOLR_CONTAINER} create_cores.sh
    _migrate_data $SOLR_HOST $SOLR_PORT
}

function demo_migrate {
    $DOCKER exec -t ${SOLR_CONTAINER} demo_create_core.sh
    $DOCKER exec -t ${SOLR_CONTAINER} demo_test.sh
}

function console {
    $DOCKER exec -it ${SOLR_CONTAINER} bash
}


function stop {
    $DOCKER stop ${SOLR_CONTAINER}
}


function help {
    echo "run|stop|console|demo|help"
}


for arg in "$ARGS"
do
    case "$arg" in
	run)
	    run
	    ;;

	stop)
	    stop
	    ;;

	migrate)
	    migrate
	    ;;

	console)
	    console
	    ;;

	demo)
	    run
            demo_migrate
            console
            stop
	    ;;

	test)
            volume_drop
	    run
            migrate
            console
            stop
	    ;;

        help)
            help
            ;;
        *)
            help
            ;;
    esac
done
